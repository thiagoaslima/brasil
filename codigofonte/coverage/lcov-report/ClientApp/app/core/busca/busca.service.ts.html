<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for ClientApp/app/core/busca/busca.service.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../../prettify.css" />
    <link rel="stylesheet" href="../../../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../../../index.html">All files</a> / <a href="index.html">ClientApp/app/core/busca</a> busca.service.ts
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/68</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/60</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/15</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/58</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104</td><td class="line-coverage quiet"><span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import { Inje<span class="cstat-no" title="statement not covered" >ctable } from '@angular/core'<span class="cstat-no" title="statement not covered" >;</span></span>
import { isBrowse<span class="cstat-no" title="statement not covered" >r, isNode } from 'angular2-un<span class="fstat-no" title="function not covered" >iv</span>ersal/browser';</span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ></span></span>
impo<span class="cstat-no" title="statement not covered" >rt { Localidade } from '../../shared2/localidade/localidade.model';<span class="cstat-no" title="statement not covered" ></span></span>
import { <span class="cstat-no" title="statement not covered" >LocalidadeService2 } from '../../shared2/localida<span class="cstat-no" title="statement not covered" >de/localidade.service';<span class="cstat-no" title="statement not covered" ></span></span></span>
impo<span class="cstat-no" title="statement not covered" >rt { Pesquisa } from '../../shared2/pesquisa/pesquisa.model';</span>
import { PesquisaService2 } from '../../shared2/pesquisa/pesquisa.service';
import { Indicado<span class="cstat-no" title="statement not covered" >r, EscopoIndicadores } from '<span class="fstat-no" title="function not covered" >..</span>/../shared2/indicador/indicador.model';</span>
impo<span class="cstat-no" title="statement not covered" >rt { IndicadorService2 } from '../../shared2/indicador/indicador.service';<span class="cstat-no" title="statement not covered" ></span></span>
import { SystemCacheService } from '../../shared/system-cache.service';
<span class="cstat-no" title="statement not covered" >import { slugify } from '../../utils/slug';</span>
import { flat<span class="cstat-no" title="statement not covered" >, flatTree, flatMap } fro</span>m '../../utils/flatFunctions';
<span class="cstat-no" title="statement not covered" ></span>
import { Observable } fro<span class="cstat-no" title="statement not covered" >m 'rxjs/Observable';</span>
import 'rxjs/add/operato<span class="cstat-no" title="statement not covered" >r/switchMap';</span>
import 'rxjs/add/observabl<span class="cstat-no" title="statement not covered" >e/forkJoin';</span>
<span class="cstat-no" title="statement not covered" ></span>
@Injectable()<span class="cstat-no" title="statement not covered" ></span>
export class BuscaServ<span class="cstat-no" title="statement not covered" >ice {</span>
<span class="cstat-no" title="statement not covered" ></span>
<span class="cstat-no" title="statement not covered" >    private _cacheKeys = {</span>
<span class="cstat-no" title="statement not covered" >        "busca": (termo: string) =&gt; `busc</span>a/${termo}`
    }<span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" ></span></span>
<span class="fstat-no" title="function not covered" ></span>
    cons<span class="cstat-no" title="statement not covered" >tructor(</span>
<span class="cstat-no" title="statement not covered" >        private _cache: SystemCacheService,</span>
<span class="cstat-no" title="statement not covered" >        private _localidadeService: LocalidadeServ</span>ice2,
<span class="cstat-no" title="statement not covered" >        private _pesquisaService: PesquisaService2,</span>
<span class="cstat-no" title="statement not covered" >        private _indicadoresService: IndicadorService2</span>
    ) { }<span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" ></span></span>
&nbsp;
    search(termo: string): Observable&lt;{ pesquisas: Pesquisa[], indicadores: Indicador[], localidades: Localidade[] }&gt; {
<span class="cstat-no" title="statement not covered" >        termo = slugify(termo.trim()<span class="fstat-no" title="function not covered" >);</span></span>
        const cacheK<span class="cstat-no" title="statement not covered" >ey = </span>this._cacheKeys.busca(termo);
<span class="cstat-no" title="statement not covered" ></span>
        if (this._cache<span class="cstat-no" title="statement not covered" >.has(cacheKey)) {</span>
<span class="cstat-no" title="statement not covered" >            return Observable.of(this._cache[cacheKey]);</span>
        }<span class="cstat-no" title="statement not covered" ></span>
&nbsp;
        let filtro = <span class="cstat-no" title="statement not covered" >this._filterSearchResponse(termo);</span>
        let _termo = <span class="cstat-no" title="statement not covered" >termo.slice(0, -1);</span>
<span class="cstat-no" title="statement not covered" ></span>
        whil<span class="cstat-no" title="statement not covered" >e (_termo) {</span>
            if (<span class="cstat-no" title="statement not covered" >this._c</span>ache.has(this._cacheKeys.busca(_termo))) {
                break;
<span class="cstat-no" title="statement not covered" >            }</span>
            _termo = _termo.slice(0, -1)
        }<span class="cstat-no" title="statement not covered" ></span>
&nbsp;
        let pesquisas$ = this._pesquisaService.getAllPesquisas();
        // let pesquisas$: Observable&lt;Pesquisa[]&gt; = _termo
        //     ? this._cach<span class="cstat-no" title="statement not covered" >e.get(_termo).pesqu<span class="fstat-no" title="function not covered" >is</span>as</span>
        //  <span class="cstat-no" title="statement not covered" >   : this._pesquisaService.getAllPesquisas();<span class="fstat-no" title="function not covered" ></span></span>
<span class="cstat-no" title="statement not covered" ></span>
        let indi<span class="cstat-no" title="statement not covered" >cadores$ = pesquisas$.flatMap(p<span class="fstat-no" title="function not covered" >es</span>quisas =&gt; {<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ></span></span></span>
&nbsp;
            ret<span class="fstat-no" title="function not covered" >ur</span>n Observable.forkJoin(.<span class="cstat-no" title="statement not covered" >..pesquisas.map(pesquisa =&gt; { </span>
                <span class="cstat-no" title="statement not covered" ></span>
<span class="cstat-no" title="statement not covered" >                let indicadoresPesquisa = this._indicadoresService.getIndicadoresByPosicao(pesquisa.id, '0', EscopoIndicadores.filhos);</span>
   <span class="fstat-no" title="function not covered" ></span>
                return indic<span class="cstat-no" title="statement not covered" >adores</span>Pesquisa.map(in<span class="cstat-no" title="statement not covered" >dicado</span>res =&gt; { debugg<span class="cstat-no" title="statement not covered" >er; re</span>turn flatTree(indicadores, 'indicadores')});
<span class="cstat-no" title="statement not covered" ></span>
            }));
        }).map( (indicadores: Indicador[][]) =&gt; flat(indicadores));     
    
        let localidade$: Observable&lt;Localidade[]&gt; = Observable.of(this._localidadeService.buscar(termo));
&nbsp;
        return Observable.zip(pesquisas$, indicadores$, localidade$)
            .map(([pesquisas, indicadores, localidades]) =&gt; {
&nbsp;
                pesquisas = pesquisas.filter(filtro.pesquisa);
                
<span class="cstat-no" title="statement not covered" >                // let hash = indicadores.filter(filtro.indicador).reduce( (obj, indicador) =&gt; {</span>
                //     obj[indicador.pesquisaId] = indicador.pesquisa;
                //     return obj;
<span class="cstat-no" title="statement not covered" >                // }, {});<span class="fstat-no" title="function not covered" ></span></span>
<span class="cstat-no" title="statement not covered" ></span>
                // Objec<span class="fstat-no" title="function not covered" >t.</span>keys(hash).forEach(key =&gt; {
<span class="cstat-no" title="statement not covered" >                //     let pesquisa = hash[key];</span>
                //     if (pesquisas.indexOf(pesquisa) === -1) {
                //    <span class="fstat-no" title="function not covered" >  </span>   pesquisas.push(pesquisa);
<span class="cstat-no" title="statement not covered" >                //     }</span>
                // })
<span class="fstat-no" title="function not covered" ></span>
<span class="cstat-no" title="statement not covered" >                return { pesquisas, indicadores, localidades }</span>
            });
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    private _filterSearch</span>Response(termo: string) {
        return {
<span class="cstat-no" title="statement not covered" >            localidade(localidade: Localidade) {</span>
                return localidade.slug.includes(termo) || localidade.sigla.toLowerCase().includes(termo) || localidade.codigo.toString().includes(termo);
            },
&nbsp;
<span class="cstat-no" title="statement not covered" >            pesquisa(pesquisa: Pesqui</span>sa) {
                return slugify(pesquisa.nome).includes(termo) || pesquisa.id.toString().includes(termo);
            },
&nbsp;
            indicador(indicador: Indicador) {
                return slugify(indicador.nome).includes(termo) || indicador.id.toString().includes(termo);
            }
        }
    }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon May 08 2017 19:39:59 GMT-0300 (BRT)
</div>
</div>
<script src="../../../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../../../sorter.js"></script>
</body>
</html>
